graph TD
    subgraph Client
        A[User Browser] -->|WebSocket Connection| B[WebSocket Server]
        A -->|1. Start Action| C[POST /api/actions/start]
        A -->|3. Complete Action| D[POST /api/actions/complete]
    end

    subgraph API Server
        C -->|Verify Auth| E[Auth Middleware]
        D -->|Verify Auth| E
        E -->|Valid Token| F[Action Controller]

        F -->|Start Action| G[Create ActionAttempt Record]
        G -->|startedAt timestamp| H[(Database)]

        F -->|Complete Action| I[Validate Attempt]
        I -->|Check timing/fraud| J{Valid?}
        J -->|No| K[Reject - 403]

        J -->|Yes| L[Redis: Check Cooldown Lock]
        L -->|Lua Script| M{Lock<br/>Acquired?}
        M -->|Exists| N[Reject - 429 Cooldown]
        M -->|Success| O[Redis: Token Bucket]

        O -->|DECR tokens| P{Tokens<br/>Available?}
        P -->|No| Q[Reject - 429 Rate Limit]
        P -->|Yes| R[BEGIN TRANSACTION]

        R -->|NOWAIT| S[Lock Action Row]
        S --> T{Points<br/>Available?}
        T -->|No| U[Rollback - 409]
        T -->|Yes| V[Award Points]

        V --> W[Update ActionAttempt]
        W --> X[Increment User.currentScore]
        X --> Y[Decrement Action.remainingPoints]
        Y -->|COMMIT| Z[Success Response]

        Z -->|Publish Event| AA[Redis Pub/Sub]
        AA -->|Score Update| AB[Cache Service]
        AB -->|Update Top 10| AC[(Redis Cache)]

        AA -->|Broadcast| B
        B -->|Push Update| A
    end

    subgraph Background Jobs
        AD[Leaderboard Updater] -->|Every 5s| AC
        AD -->|Query Top 10| H
    end

    subgraph Redis Cluster
        L -.->|Multi-instance| AE[Redis Zone 1]
        L -.->|User hash routing| AF[Redis Zone 2]
        O -.-> AE
        O -.-> AF
    end

    style L fill:#fbb,stroke:#333,stroke-width:2px
    style O fill:#fbb,stroke:#333,stroke-width:2px
    style S fill:#f9f,stroke:#333,stroke-width:2px
    style AC fill:#bbf,stroke:#333,stroke-width:2px
    style B fill:#bfb,stroke:#333,stroke-width:2px